<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bobbyç´€å…ƒ v7.1</title>
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #111;
            --text-color: #bbb;
            --font-main: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            
            /* Diablo Rarity Colors */
            --r-common: #b0b0b0;    /* ç™½ */
            --r-rare: #55aaff;      /* è— */
            --r-epic: #aa55ff;      /* ç´« */
            --r-legend: #ffaa00;    /* æ©™ */
            
            --hp-color: #ff5555;
            --san-color: #55aaff;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        #game-container {
            width: 100%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
            border: 1px solid #333;
            background: var(--panel-bg);
            box-shadow: 0 0 50px rgba(0,0,0,0.9);
            border-radius: 5px;
            position: relative;
        }

        /* é ‚éƒ¨æ•¸æ“š (å¯é»æ“ŠæŸ¥çœ‹é¢æ¿) */
        #header {
            padding: 10px;
            background: #181818;
            border-bottom: 1px solid #333;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            font-size: 0.8em;
            text-align: center;
        }
        .stat-box { cursor: pointer; transition: 0.2s; padding: 2px; border-radius: 4px; }
        .stat-box:hover { background: #333; }
        .stat-val { font-weight: bold; font-size: 1.1em; color: #fff; }
        .stat-lbl { color: #666; font-size: 0.8em; }

        /* è£å‚™æ¬„ (å¯é»æ“Š) */
        #equip-bar {
            padding: 10px;
            background: #141414;
            border-bottom: 1px solid #333;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
        }
        .eq-row { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #0a0a0a; padding: 8px 10px; border-radius: 4px; border: 1px solid #222;
            cursor: pointer; transition: 0.2s;
        }
        .eq-row:hover { border-color: #555; background: #1a1a1a; }
        .eq-label { font-size: 0.8em; color: #555; margin-right: 10px; }
        
        /* å“è³ªé¡è‰²é¡ */
        .q0 { color: var(--r-common); }
        .q1 { color: var(--r-rare); text-shadow: 0 0 5px rgba(85,170,255,0.3); }
        .q2 { color: var(--r-epic); text-shadow: 0 0 8px rgba(170,85,255,0.5); font-weight: bold; }
        .q3 { color: var(--r-legend); text-shadow: 0 0 10px rgba(255,170,0,0.6); font-weight: bold; border-bottom: 1px dashed var(--r-legend); }

        /* æ—¥èªŒ */
        #log-area {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #080808;
            font-family: 'Consolas', var(--font-main);
            border-bottom: 1px solid #333;
            line-height: 1.6;
            font-size: 0.95em;
        }
        .log-entry { margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid #1a1a1a; animation: fadeIn 0.2s; }
        .day-tag { color: #444; font-size: 0.8em; margin-right: 8px; }
        .c-gain { color: #0f0; } .c-loss { color: #f33; } .c-item { color: #fc0; } .c-epic { color: #d0f; }

        /* æ“ä½œæŒ‰éˆ• */
        #action-area {
            padding: 15px;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 200px;
        }
        .btn-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        
        button {
            background: #252525;
            color: #ccc;
            border: 1px solid #444;
            padding: 12px;
            cursor: pointer;
            text-align: left;
            transition: 0.1s;
            border-radius: 4px;
            position: relative;
        }
        button:hover { background: #333; border-color: #fff; color: #fff; transform: translateY(-1px); }
        button:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
        .val-cost { float: right; color: #d84; font-size: 0.85em; }

        /* å…¨å±å½ˆçª— (Overlay) */
        .overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95); z-index: 99;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        /* è©³æƒ…å½ˆçª— */
        #modal-content {
            background: #111; border: 1px solid #444; padding: 20px; 
            max-width: 80%; width: 400px; border-radius: 8px;
            box-shadow: 0 0 30px rgba(0,0,0,1); text-align: center;
        }
        .close-btn { margin-top: 20px; width: 100%; text-align: center; border-color: #666; }

        .job-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; width: 90%; max-height:80vh; overflow-y:auto; padding: 10px;}
        .job-card { border:1px solid #333; padding:15px; cursor:pointer; background:#111; transition: 0.2s;}
        .job-card:hover { border-color: var(--r-legend); background:#222; }

        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body>

<div id="game-container">
    <!-- é ‚éƒ¨æ•¸æ“š -->
    <div id="header">
        <div class="stat-box"><span class="stat-lbl">Day</span><span class="stat-val" id="v-day">0/105</span></div>
        <div class="stat-box"><span class="stat-lbl">HP</span><span class="stat-val" style="color:var(--hp-color)" id="v-hp">100</span></div>
        <div class="stat-box"><span class="stat-lbl">SAN</span><span class="stat-val" style="color:var(--san-color)" id="v-san">100</span></div>
        <div class="stat-box" onclick="showStats()" title="é»æ“ŠæŸ¥çœ‹è©³ç´°é¢æ¿"><span class="stat-lbl">å±¬æ€§(é»æˆ‘)</span><span class="stat-val" id="v-stats">0/0/0</span></div>
        <div class="stat-box"><span class="stat-lbl">ç‰©è³‡</span><span class="stat-val"><span id="v-food">100</span>/<span id="v-water">100</span></span></div>
    </div>
    
    <!-- è£å‚™æ¬„ï¼šå¯é»æ“Š -->
    <div id="equip-bar">
        <div class="eq-row" onclick="showItemDetail('melee')">
            <span class="eq-label">âš”ï¸ è¿‘æˆ°</span>
            <span id="eq-melee" class="q0">ç„¡</span>
        </div>
        <div class="eq-row" onclick="showItemDetail('range')">
            <span class="eq-label">ğŸ”« é ç¨‹</span>
            <span><span id="eq-range" class="q0">ç„¡</span> <span id="v-ammo" style="color:#666;font-size:0.8em">(0)</span></span>
        </div>
        <div class="eq-row" onclick="showItemDetail('head')">
            <span class="eq-label">ğŸª– é ­éƒ¨</span>
            <span id="eq-head" class="q0">ç„¡</span>
        </div>
        <div class="eq-row" onclick="showItemDetail('body')">
            <span class="eq-label">ğŸ‘• èº«é«”</span>
            <span id="eq-body" class="q0">ç„¡</span>
        </div>
    </div>

    <div id="log-area"></div>
    <div id="action-area"></div>
</div>

<!-- å½ˆçª—å±¤ -->
<div id="screen-modal" class="overlay" style="display:none" onclick="closeModal()">
    <div id="modal-content" onclick="event.stopPropagation()">
        <h2 id="m-title" style="margin:0 0 10px 0">æ¨™é¡Œ</h2>
        <div id="m-desc" style="color:#ccc; line-height:1.6; font-size:0.95em">å…§å®¹</div>
        <button class="close-btn" onclick="closeModal()">é—œé–‰</button>
    </div>
</div>

<!-- é–‹å§‹ç•«é¢ -->
<div id="screen-start" class="overlay">
    <h1 style="color:var(--r-legend); font-size: 2.5em; text-shadow: 0 0 20px rgba(255,170,0,0.5);">Bobbyç´€å…ƒ v7.1</h1>
    <p style="color:#888; margin-bottom: 30px;">é»æ“Šè£å‚™æŸ¥çœ‹è©³ç´°è©æ¢</p>
    
    <div style="display:flex; gap:20px;">
        <button onclick="setDiff(1)" style="width:140px; text-align:center;">ğŸŸ¢ æ­£å¸¸</button>
        <button onclick="setDiff(2)" style="width:140px; text-align:center; border-color:var(--r-rare)">ğŸŸ¡ å›°é›£</button>
        <button onclick="setDiff(3)" style="width:140px; text-align:center; border-color:var(--r-legend)">ğŸ”´ å™©å¤¢</button>
    </div>
</div>

<div id="screen-jobs" class="overlay" style="display:none">
    <h2 style="color:#ccc">é¸æ“‡å‰ä¸–èº«ä»½</h2>
    <div id="job-container" class="job-grid"></div>
</div>

<script>
// ==================== æ•¸æ“šåº« ====================

const BASE_DB = {
    melee: [
        {n:'æ‹³é ­',t:0,v:2}, {n:'æŒ‡ç”²éŠ¼',t:1,v:3}, {n:'åŸå­ç­†',t:1,v:4}, {n:'æ‹–é‹',t:1,v:2}, {n:'ç»ç’ƒç‰‡',t:1,v:5},
        {n:'æ°´æœåˆ€',t:2,v:10}, {n:'éµéš',t:2,v:14}, {n:'å¹³åº•é‹',t:2,v:12}, {n:'èœåˆ€',t:2,v:13}, {n:'æ‰³æ‰‹',t:2,v:11},
        {n:'æ£’çƒæ£',t:3,v:20}, {n:'æ¶ˆé˜²æ–§',t:3,v:25}, {n:'éµæ’¬',t:3,v:22}, {n:'é–‹å±±åˆ€',t:3,v:24}, {n:'è­¦æ£',t:3,v:18},
        {n:'è»ç”¨åŒ•é¦–',t:4,v:30}, {n:'æ­¦å£«åˆ€',t:4,v:38}, {n:'ç‡ƒæ²¹é›»é‹¸',t:4,v:55}, {n:'ä¸‰æ£±åˆº',t:4,v:33},
        {n:'å…‰åŠ',t:5,v:80}, {n:'é«˜é »åˆƒ',t:5,v:70}, {n:'æ­»ç¥é®åˆ€',t:5,v:75}, {n:'å‹•åŠ›æ‹³å¥—',t:5,v:65}
    ],
    ranged: [
        {n:'å°çŸ³å­',t:1,v:2}, {n:'é£›é¢',t:1,v:5}, {n:'å½ˆå¼“',t:2,v:10}, {n:'é‡˜æ§',t:2,v:15}, {n:'è‡ªè£½å¼“',t:2,v:18},
        {n:'è¤‡åˆå¼©',t:3,v:35}, {n:'è­¦ç”¨æ‰‹æ§',t:3,v:30}, {n:'å·¦è¼ª',t:3,v:45}, {n:'çµæ§',t:3,v:55},
        {n:'è¡é‹’æ§',t:4,v:40}, {n:'AK47',t:4,v:50}, {n:'AWMç‹™æ“Š',t:4,v:90}, {n:'M249æ©Ÿæ§',t:4,v:65},
        {n:'é«˜æ–¯æ­¥æ§',t:5,v:110}, {n:'é›·å°„æ§',t:5,v:100}, {n:'é»‘æ´ç‚®',t:5,v:999}
    ],
    head: [
        {n:'ç„¡',t:0,v:0}, {n:'å¡‘è† è¢‹',t:1,v:0}, {n:'è¥¿ç“œçš®',t:1,v:1}, {n:'ç´™ç®±',t:1,v:1},
        {n:'é‹è“‹',t:2,v:3}, {n:'å–®è»Šç›”',t:2,v:4}, {n:'å·¥åœ°å¸½',t:2,v:5},
        {n:'æ©Ÿè»Šç›”',t:3,v:8}, {n:'é˜²æ¯’é¢å…·',t:3,v:6}, {n:'é›»ç„Šé¢ç½©',t:3,v:7},
        {n:'é®æš´ç›”',t:4,v:12}, {n:'å‡±å¤«æ‹‰ç›”',t:4,v:16}, {n:'å¤œè¦–ç›”',t:4,v:14},
        {n:'å¤–éª¨éª¼ç›”',t:5,v:25}, {n:'æ³°å¦å‹•åŠ›ç›”',t:5,v:35}
    ],
    body: [
        {n:'ç„¡',t:0,v:0}, {n:'T-shirt',t:1,v:0}, {n:'ç´™çš®ç”²',t:1,v:1}, {n:'é›¨è¡£',t:1,v:0},
        {n:'ç‰›ä»”æœ',t:2,v:3}, {n:'çš®å¤¾å…‹',t:2,v:4}, {n:'æ£‰è¢«',t:2,v:5},
        {n:'é˜²åˆºæœ',t:3,v:10}, {n:'é˜²æ‘”è¡£',t:3,v:8}, {n:'é–å­ç”²',t:3,v:12},
        {n:'é˜²å½ˆè¡£',t:4,v:20}, {n:'æˆ°è¡“èƒŒå¿ƒ',t:4,v:22}, {n:'é‡å‹é˜²çˆ†',t:4,v:28},
        {n:'ç´ç±³ç”ŸåŒ–è£',t:5,v:45}, {n:'å‹•åŠ›è£ç”²',t:5,v:60}
    ]
};

const PREFIX = {
    atk: [ {n:'é‹’åˆ©çš„',s:'s',v:2}, {n:'æ®˜æš´çš„',dmgP:0.2}, {n:'è‡´å‘½çš„',crit:10}, {n:'æ²‰é‡çš„',s:'s',v:4} ],
    def: [ {n:'å …å›ºçš„',s:'w',v:2}, {n:'ç¡¬åŒ–çš„',defP:0.2}, {n:'åšé‡çš„',defP:0.3}, {n:'éˆå·§çš„',s:'a',v:3} ],
    util: [ {n:'è°æ˜çš„',s:'i',v:3}, {n:'å¹¸é‹çš„',loot:0.1}, {n:'ç¥è–çš„',san:2} ]
};

const SUFFIX = {
    dmg: [ {n:'ä¹‹ç‹¼',crit:15}, {n:'ä¹‹ç†Š',s:'s',v:5}, {n:'ä¹‹å¸è¡€',leech:0.1}, {n:'ä¹‹æ¯€æ»…',dmgP:0.3} ],
    sur: [ {n:'ä¹‹é¾œ',defP:0.2}, {n:'ä¹‹è²“',s:'a',v:5}, {n:'ä¹‹å†ç”Ÿ',heal:2}, {n:'ä¹‹çŸ³',hp:30} ],
    god: [ {n:'ä¹‹ç¥åŠ›',s:'s',v:10}, {n:'ä¹‹å…‰',san:5}, {n:'ä¹‹æ™‚é–“',dodge:20} ]
};

const JOBS = [
    {n:'ç‰¹ç¨®å…µ', s:{s:8,a:6,i:4,w:7}, g:['è»ç”¨åŒ•é¦–','ç„¡','ç„¡','é˜²åˆºæœ'], ammo:0},
    {n:'åˆ‘è­¦', s:{s:6,a:6,i:5,w:6}, g:['è­¦æ£','è­¦ç”¨æ‰‹æ§','ç„¡','é˜²å½ˆè¡£'], ammo:15},
    {n:'æ­»å®…', s:{s:3,a:4,i:7,w:5}, g:['æ­¦å£«åˆ€','ç„¡','å…§è¤²','T-shirt'], ammo:0},
    {n:'é†«ç”Ÿ', s:{s:3,a:5,i:9,w:8}, g:['æ°´æœåˆ€','ç„¡','ç„¡','ç„¡'], ammo:0},
    {n:'å»ºç¯‰å·¥', s:{s:9,a:4,i:3,w:6}, g:['éµéš','é‡˜æ§','å·¥åœ°å¸½','ç‰›ä»”æœ'], ammo:20},
    {n:'å­¸ç”Ÿ', s:{s:4,a:6,i:6,w:6}, g:['æ£’çƒæ£','å½ˆå¼“','ç„¡','T-shirt'], ammo:10},
    {n:'æ®ºæ‰‹', s:{s:5,a:8,i:6,w:5}, g:['ä¸‰æ£±åˆº','ç„¡','ç„¡','è¥¿è£'], ammo:0},
    {n:'ç˜‹å­', s:{s:5,a:5,i:2,w:10}, g:['ç‡ƒæ²¹é›»é‹¸','ç„¡','ç„¡','ç„¡'], ammo:0}
];

// ==================== éŠæˆ²ç‹€æ…‹ ====================
let G = {
    day:0, maxDay:105, diff:1,
    hp:100, maxHp:100, san:100,
    food:100, water:100, ammo:0,
    stats:{s:0,a:0,i:0,w:0},
    eq:{melee:null, range:null, head:null, body:null},
    buffs:[], alive:true, job:''
};

// ==================== è£å‚™ç³»çµ± ====================

function createItem(type, baseName, forcedTier = null) {
    let template = BASE_DB[type].find(i => baseName.includes(i.n)) || BASE_DB[type][0];
    let tier = forcedTier !== null ? forcedTier : template.t;
    let variance = 0.85 + Math.random() * 0.3;
    let val = Math.floor(template.v * variance);
    let luck = (G.stats.i * 2) + (G.day / 2); 
    let roll = Math.random() * 100 + luck;
    let rarity = 0; 
    if (roll > 115) rarity = 3;
    else if (roll > 90) rarity = 2;
    else if (roll > 60) rarity = 1;
    if (forcedTier === 0) rarity = 0;

    let item = { name: template.n, type: type, tier: tier, rarity: rarity, val: val, stats: {}, affixes: [] };

    if (rarity >= 1) addAffix(item, 'prefix');
    if (rarity >= 2) addAffix(item, 'suffix');
    if (rarity >= 3) { addAffix(item, Math.random()>0.5 ? 'prefix':'suffix'); item.val = Math.floor(item.val * 1.3); }

    let pre = item.affixes.find(a=>a.type=='prefix')?.n || '';
    let suf = item.affixes.find(a=>a.type=='suffix')?.n || '';
    item.fullName = `${pre} ${item.name} ${suf}`.trim();
    return item;
}

function addAffix(item, type) {
    let pool = [];
    if (item.type === 'melee' || item.type === 'ranged') pool = type === 'prefix' ? PREFIX.atk : SUFFIX.dmg;
    else pool = type === 'prefix' ? PREFIX.def : SUFFIX.sur;
    if(Math.random()>0.7) pool = pool.concat(type==='prefix'?PREFIX.util : SUFFIX.god);

    let affix = pool[Math.floor(Math.random() * pool.length)];
    item.affixes.push({n:affix.n, type:type});
    for (let k in affix) {
        if (k === 'n' || k === 'type') continue;
        if (!item.stats[k]) item.stats[k] = 0;
        let v = affix[k];
        if (k === 'v') item.stats[affix.s] = (item.stats[affix.s]||0) + Math.floor(v * (1 + item.tier*0.5));
        else item.stats[k] += v;
    }
}

function generateLoot(type) {
    let tier = 1 + Math.floor(G.day / 22);
    tier += Math.floor(Math.random()*3) - 1; 
    tier = Math.max(1, Math.min(5, tier));
    let pool = BASE_DB[type].filter(i => i.t === tier || i.t === tier - 1);
    if(pool.length === 0) pool = BASE_DB[type];
    let template = pool[Math.floor(Math.random()*pool.length)];
    return createItem(type, template.n);
}

function getStat(key) {
    let base = G.stats[key] || 0;
    for(let slot in G.eq) if(G.eq[slot] && G.eq[slot].stats && G.eq[slot].stats[key]) base += G.eq[slot].stats[key];
    if(key === 's') base += getStatBonus('s');
    if(key === 'a') base += getStatBonus('a');
    if(key === 'i') base += getStatBonus('i');
    return base;
}

function getStatBonus(key) {
    let val = 0;
    for(let slot in G.eq) if(G.eq[slot] && G.eq[slot].stats && G.eq[slot].stats[key]) val += G.eq[slot].stats[key];
    return val;
}

function getCombatStats() {
    let def = (G.eq.head?.val||0) + (G.eq.body?.val||0);
    let defP = 0; for(let slot in G.eq) defP += (G.eq[slot]?.stats?.defP || 0);
    def = Math.floor(def * (1 + defP));
    let crit = 5 + (getStat('a')/2); for(let slot in G.eq) crit += (G.eq[slot]?.stats?.crit || 0);
    let dodge = getStat('a')/2; for(let slot in G.eq) dodge += (G.eq[slot]?.stats?.dodge || 0);
    let leech = 0; for(let slot in G.eq) leech += (G.eq[slot]?.stats?.leech || 0);
    return { def, crit, dodge, leech };
}

// ==================== UI è©³æƒ…é¡¯ç¤ºé‚è¼¯ (v7.1 æ–°å¢) ====================

function showItemDetail(slot) {
    const item = G.eq[slot];
    if(!item || item.name === 'ç„¡') return;
    
    const rNames = ['æ™®é€š','ç¨€æœ‰','å²è©©','å‚³èªª'];
    const rColors = ['var(--r-common)','var(--r-rare)','var(--r-epic)','var(--r-legend)'];
    const typeName = slot === 'melee' ? 'è¿‘æˆ°æ­¦å™¨' : slot === 'ranged' ? 'é ç¨‹æ­¦å™¨' : slot === 'head' ? 'é ­ç›”' : 'è­·ç”²';
    
    let html = `<div style="color:${rColors[item.rarity]}; font-size:1.2em; font-weight:bold; margin-bottom:5px;">${item.fullName}</div>`;
    html += `<div style="font-size:0.9em; color:#888; margin-bottom:10px;">Tier ${item.tier} ${rNames[item.rarity]} ${typeName}</div>`;
    
    // åŸºç¤æ•¸å€¼
    if(item.val > 0) {
        let label = (slot.includes('head') || slot.includes('body')) ? 'ğŸ›¡ï¸ é˜²ç¦¦åŠ›' : 'âš”ï¸ æ”»æ“ŠåŠ›';
        html += `<div style="font-size:1.1em; color:#eee; margin-bottom:10px;">${label}: ${item.val}</div>`;
    }

    // è©æ¢å±¬æ€§
    let statHtml = '';
    const map = {
        s: 'åŠ›é‡', a: 'æ•æ·', i: 'æ™ºåŠ›', w: 'æ„å¿—',
        dmgP: 'å‚·å®³åŠ æˆ', defP: 'é˜²ç¦¦åŠ æˆ', crit: 'æš´æ“Šç‡', dodge: 'é–ƒé¿ç‡',
        leech: 'å¸è¡€', heal: 'æ¯æ—¥å›è¡€', san: 'æ¯æ—¥å›SAN', hp: 'ç”Ÿå‘½ä¸Šé™', loot: 'å¹¸é‹å€¼'
    };

    for(let k in item.stats) {
        let v = item.stats[k];
        let valStr = v;
        if(['dmgP','defP','leech','loot'].includes(k)) valStr = Math.floor(v*100) + '%';
        else valStr = '+' + v;
        
        // ç‰¹æ®Šå–®ä½
        if(k === 'crit' || k === 'dodge') valStr += '%';

        statHtml += `<div style="color:#aaa">${map[k] || k}: <span style="color:#fff">${valStr}</span></div>`;
    }
    
    if(statHtml) html += `<div style="background:#222; padding:10px; border-radius:4px; margin-top:10px;">${statHtml}</div>`;
    else html += `<div style="color:#555; margin-top:10px;">(ç„¡é¡å¤–è©æ¢)</div>`;

    openModal('', html);
}

function showStats() {
    let cs = getCombatStats();
    let html = `<div style="text-align:left; padding:0 20px;">`;
    html += `<p>ğŸ’ª <strong>åŠ›é‡:</strong> ${getStat('s')} <span style="color:#666;font-size:0.8em">(è¿‘æˆ°å‚·å®³)</span></p>`;
    html += `<p>ğŸ¦µ <strong>æ•æ·:</strong> ${getStat('a')} <span style="color:#666;font-size:0.8em">(é ç¨‹å‚·å®³/æš´æ“Š/é–ƒé¿)</span></p>`;
    html += `<p>ğŸ§  <strong>æ™ºåŠ›:</strong> ${getStat('i')} <span style="color:#666;font-size:0.8em">(æœåˆ®å“è³ª/è£½ä½œ)</span></p>`;
    html += `<hr style="border-color:#333">`;
    html += `<p>ğŸ›¡ï¸ <strong>ç¸½é˜²ç¦¦:</strong> ${cs.def}</p>`;
    html += `<p>ğŸ’¥ <strong>æš´æ“Šç‡:</strong> ${Math.floor(cs.crit)}%</p>`;
    html += `<p>ğŸ’¨ <strong>é–ƒé¿ç‡:</strong> ${Math.floor(cs.dodge)}%</p>`;
    html += `<p>ğŸ©¸ <strong>å¸è¡€ç‡:</strong> ${Math.floor(cs.leech*100)}%</p>`;
    html += `</div>`;
    
    openModal('è§’è‰²é¢æ¿', html);
}

function openModal(title, content) {
    document.getElementById('m-title').innerText = title;
    // å¦‚æœæ²’æœ‰æ¨™é¡Œï¼Œéš±è—æ¨™é¡Œæ¬„
    document.getElementById('m-title').style.display = title ? 'block' : 'none';
    document.getElementById('m-desc').innerHTML = content;
    document.getElementById('screen-modal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('screen-modal').style.display = 'none';
}

// ==================== æµç¨‹æ§åˆ¶ ====================

function setDiff(d) {
    G.diff = d;
    document.getElementById('screen-start').style.display = 'none';
    document.getElementById('screen-jobs').style.display = 'flex';
    
    const box = document.getElementById('job-container');
    JOBS.forEach(j => {
        const d = document.createElement('div');
        d.className = 'job-card';
        d.innerHTML = `<strong class="q3">${j.n}</strong><br>
        <span style="font-size:0.8em;color:#aaa">åŠ›${j.s.s} æ•${j.s.a} æ™º${j.s.i}</span><br>
        <span style="font-size:0.8em;color:#666">${j.g.join(', ')}</span>`;
        d.onclick = () => startGame(j);
        box.appendChild(d);
    });
}

function startGame(job) {
    G.job = job.n;
    G.stats = {...job.s};
    G.ammo = job.ammo;
    
    G.eq.melee = createItem('melee', job.g[0], job.g[0].includes('ç„¡')?0:null);
    G.eq.range = createItem('ranged', job.g[1], job.g[1].includes('ç„¡')?0:null);
    G.eq.head = createItem('head', job.g[2], job.g[2].includes('ç„¡')?0:null);
    G.eq.body = createItem('body', job.g[3], job.g[3].includes('ç„¡')?0:null);

    if(G.diff === 3) { G.food=50; G.water=50; G.hp=80; }

    document.getElementById('screen-jobs').style.display = 'none';
    log('ç³»çµ±', `é›£åº¦:${['æ­£å¸¸','å›°é›£','å™©å¤¢'][G.diff-1]} | è·æ¥­:${G.job}`);
    updateUI();
    campPhase();
}

function campPhase() {
    if(!G.alive) return;
    G.day++;

    let msgs = [];
    if(G.buffs.includes('bleed')) { G.hp-=8; msgs.push("ğŸ©¸å¤±è¡€-8"); }
    
    let heal = 0, sanRec = 0;
    for(let s in G.eq) {
        heal += (G.eq[s]?.stats?.heal || 0);
        sanRec += (G.eq[s]?.stats?.san || 0);
    }
    if(heal>0) { G.hp+=heal; msgs.push(`å›è¡€+${heal}`); }
    if(sanRec>0) { G.san+=sanRec; msgs.push(`å›SAN+${sanRec}`); }

    let cost = 10 * G.diff;
    G.food -= cost; G.water -= cost + 5;
    
    if(msgs.length) log('ç‹€æ…‹', msgs.join(', '));
    if(G.food<0 || G.water<0) { G.hp-=15; log('ç”Ÿå­˜', 'é£¢æ¸´åå™¬ç”Ÿå‘½ (-15HP)', 'c-loss'); }
    if(G.san<=0) { G.hp-=25; log('ç†æ™º', 'ç²¾ç¥å´©æ½° (-25HP)', 'c-loss'); }

    if(G.hp > G.maxHp) G.hp = G.maxHp;
    if(G.san > 100) G.san = 100;

    if(G.hp <= 0) return gameOver('æ­»æ–¼ç”Ÿå­˜è€—ç«­');
    if(G.day === G.maxDay) return triggerEvent(evt_boss);

    updateUI();
    
    const area = document.getElementById('action-area');
    area.innerHTML = `
        <div style="border-bottom:1px solid #333;margin-bottom:10px;padding-bottom:5px">
            <strong style="color:#fff">â›º ç‡Ÿåœ° Day ${G.day}</strong>
        </div>
        <div class="btn-grid">
            <button onclick="handleCamp('scavenge')">ğŸ™ï¸ æœåˆ®ç‰©è³‡<br><span class="val-cost">ç²¾åŠ›-20</span></button>
            <button onclick="handleCamp('rest')">ğŸ’¤ ä¼‘æ¯é¤Šå‚·<br><span class="val-cost">é£Ÿç‰©-20</span></button>
            <button onclick="handleCamp('train')">ğŸ‹ï¸ è¨“ç·´å±¬æ€§<br><span class="val-cost">æ°´-30</span></button>
        </div>
    `;
}

function handleCamp(act) {
    if(act === 'rest') {
        if(G.food < 20) { log('æç¤º','é£Ÿç‰©ä¸è¶³'); return; }
        G.food -= 20;
        G.hp = Math.min(G.maxHp, G.hp+40);
        G.san = Math.min(100, G.san+30);
        if(Math.random()>0.5) G.buffs = [];
        log('ä¼‘æ¯', 'ç‹€æ…‹å¤§å¹…æ¢å¾©');
        triggerEvent(evt_night);
    } else if (act === 'train') {
        if(G.water < 30) { log('æç¤º','æ°´ä¸è¶³'); return; }
        G.water -= 30;
        let s = ['s','a','i'][Math.floor(Math.random()*3)];
        G.stats[s]++;
        log('æˆé•·', `${s=='s'?'åŠ›é‡':s=='a'?'æ•æ·':'æ™ºåŠ›'} +1`, 'c-gain');
        triggerEvent(evt_night);
    } else {
        generateEvent();
    }
}

function generateEvent() {
    let r = Math.random();
    let combatChance = 0.4 + (G.day/180);
    if(r < combatChance) triggerEvent(evt_combat);
    else triggerEvent(evt_loot);
}

function triggerEvent(fn) {
    let e = fn();
    let area = document.getElementById('action-area');
    area.innerHTML = `<h3 style="color:#fff;margin:0 0 10px 0">${e.title}</h3><p style="color:#aaa">${e.desc}</p><div class="btn-grid" id="opts-grid"></div>`;
    let g = document.getElementById('opts-grid');
    e.opts.forEach(o => {
        let b = document.createElement('button');
        b.innerHTML = o.txt;
        if(o.disabled) b.disabled=true;
        b.onclick = ()=>{ o.func(); updateUI(); };
        g.appendChild(b);
    });
}

const evt_night = () => {
    return {
        title: "ğŸŒ™ å¤œæ™š", desc: "å¤œæ™šå……æ»¿å±éšª...",
        opts: [{txt:"åº¦éå¤œæ™š", func:()=>{
            if(Math.random() < 0.2) {
                let dmg = 15 + Math.floor(G.day/3);
                let cs = getCombatStats();
                let take = Math.max(0, dmg - cs.def);
                G.hp -= take;
                log('å¤œè¥²', `é­å—æ”»æ“Š! å—å‚·${take} (é˜²ç¦¦${cs.def})`, 'c-loss');
            }
            campPhase();
        }}]
    };
};

const evt_loot = () => {
    return {
        title: "ğŸ“¦ æœåˆ®", desc: "ä½ ç™¼ç¾äº†ä¸€è™•æœªæ¢ç´¢çš„å»¢å¢Ÿã€‚",
        opts: [
            {txt:`æœç´¢ (æ™ºåŠ›${getStat('i')})`, func:()=>{
                let bonus = 0;
                for(let s in G.eq) bonus += (G.eq[s]?.stats?.loot || 0);

                if(Math.random()*20 + getStat('i') + (bonus*100) > 10) {
                    let type = ['melee','ranged','head','body'][Math.floor(Math.random()*4)];
                    let item = generateLoot(type);
                    
                    // å½ˆçª—é¡¯ç¤ºæ’¿åˆ°çš„è£å‚™
                    let html = `<div style="font-weight:bold; color:${['#ccc','#5af','#a5f','#fa0'][item.rarity]}">${item.fullName}</div>`;
                    if(item.val) html += `<div>${type.includes('ed')?'æ”»':'é˜²'}: ${item.val}</div>`;
                    for(let k in item.stats) html += `<div style="font-size:0.9em;color:#aaa">${k}:${item.stats[k]}</div>`;
                    
                    openModal('æˆ°åˆ©å“ç™¼ç¾!', html + `<br><p>ä½ è¦æ›´æ›ç•¶å‰è£å‚™å—ï¼Ÿ</p>
                        <button onclick="equipFoundItem('${type}')" style="width:100%;text-align:center;margin-bottom:5px">æ›´æ›</button>
                        <button onclick="closeModal(); triggerEvent(evt_night)" style="width:100%;text-align:center;border-color:#555">ä¸Ÿæ£„</button>`);
                    
                    // æš«å­˜æ­¤ç‰©å“ä»¥ä¾¿åœ¨ modal ä¸­èª¿ç”¨
                    G.foundItem = item;
                    G.food+=15; G.ammo+=5;
                } else {
                    log('æœåˆ®', 'ä¸€ç„¡æ‰€ç²');
                    triggerEvent(evt_night);
                }
            }},
            {txt:'é›¢é–‹', func:()=>triggerEvent(evt_night)}
        ]
    };
};

// ç‚ºäº†è®“å½ˆçª—æŒ‰éˆ•èƒ½å‘¼å«
window.equipFoundItem = function(type) {
    G.eq[type] = G.foundItem;
    log('è£å‚™', `æ›ä¸Šäº† ${G.foundItem.fullName}`, 'c-gain');
    updateUI();
    closeModal();
    triggerEvent(evt_night);
};

const evt_combat = () => {
    let scale = 1 + (G.day / 20);
    let hp = Math.floor((30 + G.day*4) * scale);
    let atk = Math.floor((8 + G.day*0.8) * scale * G.diff);
    let name = ['ç‹‚æš´è€…','æ­¦è£æš´å¾’','ç”ŸåŒ–ç¸','å¤œé­”'][Math.floor(Math.random()*4)];

    const fight = (range) => {
        let cs = getCombatStats();
        let dmg = range ? G.eq.range.val + getStat('a') : G.eq.melee.val + getStat('s');
        if(range) G.ammo--;
        
        let dmgP = 0; for(let s in G.eq) dmgP += (G.eq[s]?.stats?.dmgP || 0);
        dmg = Math.floor(dmg * (1 + dmgP));
        if(Math.random()*100 < cs.crit) { dmg *= 2; log('æˆ°é¬¥', 'æš´æ“Š!', 'c-epic'); }

        let incoming = Math.max(1, atk - cs.def);
        if(Math.random()*100 < cs.dodge) { incoming = 0; log('æˆ°é¬¥', 'é–ƒé¿!', 'c-gain'); }

        hp -= dmg;
        G.hp -= incoming;
        if(cs.leech > 0) { let heal = Math.floor(dmg * cs.leech); if(heal>0) G.hp+=heal; }

        log('äº¤é‹’', `å‚·æ•µ${dmg} / å—å‚·${incoming}`);

        if(G.hp <= 0) return gameOver(`è¢« ${name} æ®ºæ­»`);
        if(hp <= 0) {
            log('å‹åˆ©', `æ“Šæ®º ${name}`, 'c-gain');
            if(Math.random() < 0.3) {
                 let item = generateLoot(['melee','ranged','head','body'][Math.floor(Math.random()*4)]);
                 // æˆ°é¬¥æ‰è½ç›´æ¥æ”¾å…¥èƒŒåŒ…æç¤º (ç°¡åŒ–ç‰ˆ)
                 log('æ‰è½', `æ€ªç‰©æ‰è½: ${item.fullName}`);
                 if(confirm(`æˆ°åˆ©å“: ${item.fullName}\næ›´æ›?`)) G.eq[item.type] = item;
            }
            return triggerEvent(evt_night);
        }

        triggerEvent(() => ({
            title:`âš”ï¸ ${name}`, desc:`æ•µHP:${hp} (æ”»${atk}) | æˆ‘HP:${Math.floor(G.hp)} (é˜²${cs.def})`,
            opts:[
                {txt:`å°„æ“Š`, disabled:G.ammo<=0, func:()=>fight(true)},
                {txt:`è¿‘æˆ°`, func:()=>fight(false)},
                {txt:`é€ƒè·‘`, func:()=>triggerEvent(evt_night)}
            ]
        }));
    };

    return { title:`é­é‡ ${name}`, desc:`æ®ºæ°£é¨°é¨°...`, opts:[{txt:'é–‹æˆ°',func:()=>fight(false)}] };
};

const evt_boss = () => {
    let bossHp = 10000 * G.diff;
    let bossAtk = 150 * G.diff;
    
    const fight = () => {
        let cs = getCombatStats();
        let dmg = (G.ammo>0 ? (G.eq.range.val+getStat('a')) : (G.eq.melee.val+getStat('s')));
        if(G.ammo>0) G.ammo--;

        let dmgP = 0; for(let s in G.eq) dmgP += (G.eq[s]?.stats?.dmgP || 0);
        dmg = Math.floor(dmg * (1 + dmgP));
        if(Math.random()*100 < cs.crit) dmg *= 2;

        let incoming = Math.max(10, bossAtk - cs.def);
        if(Math.random()*100 < cs.dodge) incoming = 0;

        bossHp -= dmg;
        G.hp -= incoming;
        if(cs.leech > 0) G.hp += Math.floor(dmg * cs.leech);

        log('æ±ºæˆ°', `BOSS HP:${bossHp} | å‚·å®³:${incoming}`, 'c-epic');

        if(G.hp <= 0) return gameOver("ä½ æœªèƒ½é˜»æ­¢æœ«æ—¥...");
        if(bossHp <= 0) {
            document.getElementById('action-area').innerHTML = `
            <div style="text-align:center">
                <h1 class="q3">å‚³å¥‡å€–å­˜è€…</h1>
                <p>ä½ æ“Šæ•—äº†åŸåˆæ„ŸæŸ“é«”ï¼Œä½ æ˜¯æ–°ä¸–ç•Œçš„ç¥ã€‚</p>
                <p class="q3">æœ€çµ‚è£å‚™: ${G.eq.melee.fullName} / ${G.eq.body.fullName}</p>
                <button onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
            </div>`;
        } else {
            setTimeout(fight, 300);
        }
    };
    return { title:"â˜ ï¸ æœ€çµ‚æ±ºæˆ°ï¼šåŸåˆæ„ŸæŸ“é«”", desc:"HP: ??? | æ”»æ“Š: ???", opts:[{txt:"æ±ºä¸€æ­»æˆ°", func:fight}] };
};

function log(t, m, c='') {
    let d = document.getElementById('log-area');
    d.innerHTML += `<div class="log-entry"><span class="day-tag">D${G.day}</span>[${t}] <span class="${c}">${m}</span></div>`;
    d.scrollTop = d.scrollHeight;
}
function updateUI() {
    document.getElementById('v-day').innerText = `${G.day}/${G.maxDay}`;
    document.getElementById('v-hp').innerText = Math.floor(G.hp);
    document.getElementById('v-san').innerText = Math.floor(G.san);
    document.getElementById('v-food').innerText = Math.floor(G.food);
    document.getElementById('v-water').innerText = Math.floor(G.water);
    document.getElementById('v-ammo').innerText = `(${G.ammo})`;
    document.getElementById('v-stats').innerText = `${getStat('s')}/${getStat('a')}/${getStat('i')}`;
    ['melee','range','head','body'].forEach(s => {
        let el = document.getElementById(`eq-${s}`);
        let item = G.eq[s];
        el.className = `q${item.rarity}`;
        el.innerText = item.fullName;
    });
}
function gameOver(msg) {
    G.alive = false;
    document.getElementById('action-area').innerHTML = `<div style="text-align:center;color:#f33"><h2>GAME OVER</h2><p>${msg}</p><button onclick="location.reload()">RETRY</button></div>`;
}

// è¼”åŠ©å‡½å¼å®šç¾©
function getStat(key) {
    let base = G.stats[key] || 0;
    for(let slot in G.eq) if(G.eq[slot] && G.eq[slot].stats && G.eq[slot].stats[key]) base += G.eq[slot].stats[key];
    if(key === 's') base += getStatBonus('s');
    if(key === 'a') base += getStatBonus('a');
    if(key === 'i') base += getStatBonus('i');
    return base;
}
function getStatBonus(key) {
    let val = 0;
    for(let slot in G.eq) if(G.eq[slot] && G.eq[slot].stats && G.eq[slot].stats[key]) val += G.eq[slot].stats[key];
    return val;
}
function getCombatStats() {
    let def = (G.eq.head?.val||0) + (G.eq.body?.val||0);
    let defP = 0; for(let slot in G.eq) defP += (G.eq[slot]?.stats?.defP || 0);
    def = Math.floor(def * (1 + defP));
    let crit = 5 + (getStat('a')/2); for(let slot in G.eq) crit += (G.eq[slot]?.stats?.crit || 0);
    let dodge = getStat('a')/2; for(let slot in G.eq) dodge += (G.eq[slot]?.stats?.dodge || 0);
    let leech = 0; for(let slot in G.eq) leech += (G.eq[slot]?.stats?.leech || 0);
    return { def, crit, dodge, leech };
}
function createItem(type, baseName, forcedTier = null) {
    let template = BASE_DB[type].find(i => baseName.includes(i.n)) || BASE_DB[type][0];
    let tier = forcedTier !== null ? forcedTier : template.t;
    let variance = 0.85 + Math.random() * 0.3;
    let val = Math.floor(template.v * variance);
    let luck = (G.stats.i * 2) + (G.day / 2); 
    let roll = Math.random() * 100 + luck;
    let rarity = 0; 
    if (roll > 115) rarity = 3;
    else if (roll > 90) rarity = 2;
    else if (roll > 60) rarity = 1;
    if (forcedTier === 0) rarity = 0;

    let item = { name: template.n, type: type, tier: tier, rarity: rarity, val: val, stats: {}, affixes: [] };

    if (rarity >= 1) addAffix(item, 'prefix');
    if (rarity >= 2) addAffix(item, 'suffix');
    if (rarity >= 3) { addAffix(item, Math.random()>0.5 ? 'prefix':'suffix'); item.val = Math.floor(item.val * 1.3); }

    let pre = item.affixes.find(a=>a.type=='prefix')?.n || '';
    let suf = item.affixes.find(a=>a.type=='suffix')?.n || '';
    item.fullName = `${pre} ${item.name} ${suf}`.trim();
    return item;
}
function addAffix(item, type) {
    let pool = [];
    if (item.type === 'melee' || item.type === 'ranged') pool = type === 'prefix' ? PREFIX.atk : SUFFIX.dmg;
    else pool = type === 'prefix' ? PREFIX.def : SUFFIX.sur;
    if(Math.random()>0.7) pool = pool.concat(type==='prefix'?PREFIX.util : SUFFIX.god);

    let affix = pool[Math.floor(Math.random() * pool.length)];
    item.affixes.push({n:affix.n, type:type});
    for (let k in affix) {
        if (k === 'n' || k === 'type') continue;
        if (!item.stats[k]) item.stats[k] = 0;
        let v = affix[k];
        if (k === 'v') item.stats[affix.s] = (item.stats[affix.s]||0) + Math.floor(v * (1 + item.tier*0.5));
        else item.stats[k] += v;
    }
}
function generateLoot(type) {
    let tier = 1 + Math.floor(G.day / 22);
    tier += Math.floor(Math.random()*3) - 1; 
    tier = Math.max(1, Math.min(5, tier));
    let pool = BASE_DB[type].filter(i => i.t === tier || i.t === tier - 1);
    if(pool.length === 0) pool = BASE_DB[type];
    let template = pool[Math.floor(Math.random()*pool.length)];
    return createItem(type, template.n);
}

</script>
</body>
</html>
